<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>ParticleDA.jl · ParticleDA</title><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href>ParticleDA</a></span></div><form class="docs-search" action="search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li class="is-active"><a class="tocitem" href>ParticleDA.jl</a><ul class="internal"><li><a class="tocitem" href="#Installation"><span>Installation</span></a></li><li><a class="tocitem" href="#Usage"><span>Usage</span></a></li><li><a class="tocitem" href="#Example:-estimating-the-state-in-a-tsunami-model"><span>Example: estimating the state in a tsunami model</span></a></li><li><a class="tocitem" href="#Output"><span>Output</span></a></li><li><a class="tocitem" href="#Running-in-parallel"><span>Running in parallel</span></a></li><li><a class="tocitem" href="#Testing"><span>Testing</span></a></li><li><a class="tocitem" href="#License"><span>License</span></a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>ParticleDA.jl</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>ParticleDA.jl</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/master/docs/src/index.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="ParticleDA.jl"><a class="docs-heading-anchor" href="#ParticleDA.jl">ParticleDA.jl</a><a id="ParticleDA.jl-1"></a><a class="docs-heading-anchor-permalink" href="#ParticleDA.jl" title="Permalink"></a></h1><p><a href="https://github.com/Team-RADDISH/ParticleDA.jl"><code>ParticleDA.jl</code></a> is a Julia package to perform data assimilation with particle filters, distributed using MPI.</p><h2 id="Installation"><a class="docs-heading-anchor" href="#Installation">Installation</a><a id="Installation-1"></a><a class="docs-heading-anchor-permalink" href="#Installation" title="Permalink"></a></h2><p>To install the package, open <a href="https://docs.julialang.org/en/v1/stdlib/REPL/">Julia&#39;s REPL</a>,  enter the package manager with <code>]</code>, then run the command</p><pre><code class="nohighlight hljs">add https://github.com/Team-RADDISH/ParticleDA.jl.git</code></pre><p>If you plan to develop the package (make changes, submit pull requests, etc), in the package manager mode run this command</p><pre><code class="nohighlight hljs">dev https://github.com/Team-RADDISH/ParticleDA.jl.git</code></pre><p>This will automatically clone the repository to your local directory <code>~/.julia/dev/ParticleDA</code>.</p><p>You can exit from the package manager mode by pressing <code>CTRL + C</code> or, alternatively, the backspace key when there is no input in the prompt.</p><h2 id="Usage"><a class="docs-heading-anchor" href="#Usage">Usage</a><a id="Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Usage" title="Permalink"></a></h2><p>After installing the package, you can start using it in Julia&#39;s REPL with</p><pre><code class="language-julia hljs">using ParticleDA</code></pre><p>The run the particle filter you can use the function <code>run_particle_filter</code>:</p><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.run_particle_filter" href="#ParticleDA.run_particle_filter"><code>ParticleDA.run_particle_filter</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">run_particle_filter(
    init_model,
    input_file_path,
    observation_file_path,
    filter_type=BootstrapFilter,
    summary_stat_type=MeanAndVarSummaryStat;
    rng=Random.TaskLocalRNG()
) -&gt; Tuple{Matrix, Union{NamedTuple, Nothing}}</code></pre><p>Run particle filter. <code>init_model</code> is the function which initialise the model, <code>input_file_path</code> is the path to the YAML file with the input parameters. <code>observation_file_path</code> is the path to the HDF5 file containing the observation sequence to perform filtering for. <code>filter_type</code> is the particle filter type to use.   See <a href="#ParticleDA.ParticleFilter"><code>ParticleFilter</code></a> for the possible values. <code>summary_stat_type</code> is a type  specifying the summary statistics of the particles to compute at each time step. See  <a href="#ParticleDA.AbstractSummaryStat"><code>AbstractSummaryStat</code></a> for the possible values. <code>rng</code> is a random number generator to use to generate random variates while filtering - a seeded random  number generator may be specified to ensure reproducible results. If running with multiple threads a thread-safe generator such as <code>Random.TaskLocalRNG</code> (the default) must be used.</p><p>Returns a tuple containing the state particles representing an estimate of the filtering distribution at the final observation time (with each particle a column of the returned matrix) and a named tuple containing the estimated summary statistics of this final  filtering distribution. If running on multiple ranks using MPI, the returned states array will correspond only to the particles local to this rank and the summary statistics will be returned only on the master rank with all other ranks returning <code>nothing</code> for their second return value.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/ParticleDA.jl#L92-L121">source</a></section></article><p>To simulate observations from the model (which can be used to for example test the filtering algorithms) you can use the function <code>simulate_observations_from_model</code></p><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.simulate_observations_from_model" href="#ParticleDA.simulate_observations_from_model"><code>ParticleDA.simulate_observations_from_model</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">simulate_observations_from_model(
    init_model, input_file_path, output_file_path; rng=Random.TaskLocalRNG()
) -&gt; Matrix</code></pre><p>Simulate observations from the state space model initialised by the <code>init_model</code> function with parameters specified by the <code>model</code> key in the input YAML file at  <code>input_file_path</code> and save the simulated observation and state sequences to a HDF5 file at <code>output_file_path</code>. <code>rng</code> is a random number generator to use to generate random variates while simulating from the model - a seeded random number generator may be specified to ensure reproducible results.</p><p>The input YAML file at <code>input_file_path</code> should have a <code>simulate_observations</code> key with value a dictionary with keys <code>seed</code> and <code>n_time_step</code> corresponding to respectively the number of time steps to generate observations for from the model and the seed to use to initialise the state of the random number generator used to simulate the observations.</p><p>The simulated observation sequence is returned as a matrix with columns corresponding to the observation vectors at each time step.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/ParticleDA.jl#L25-L45">source</a></section></article><p>The <code>filter_type</code> argument to <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> should be a concrete subtype of the <code>ParticleFilter</code> abstract type.</p><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.ParticleFilter" href="#ParticleDA.ParticleFilter"><code>ParticleDA.ParticleFilter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">ParticleFilter</code></pre><p>Abstract type for particle filters.  Currently implemented subtypes are:</p><ul><li><a href="#ParticleDA.BootstrapFilter"><code>BootstrapFilter</code></a></li><li><a href="#ParticleDA.OptimalFilter"><code>OptimalFilter</code></a></li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/filters.jl#L1-L7">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.BootstrapFilter" href="#ParticleDA.BootstrapFilter"><code>ParticleDA.BootstrapFilter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">BootstrapFilter &lt;: ParticleFilter</code></pre><p>Singleton type <code>BootstrapFilter</code>.  This can be used as argument of  <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> to select the bootstrap filter.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/filters.jl#L39-L44">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.OptimalFilter" href="#ParticleDA.OptimalFilter"><code>ParticleDA.OptimalFilter</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">OptimalFilter &lt;: ParticleFilter</code></pre><p>Singleton type <code>OptimalFilter</code>.  This can be used as argument of  <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> to select the optimal proposal filter (for conditionally linear-Gaussian models).</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/filters.jl#L47-L53">source</a></section></article><p>The <code>summary_stat_type</code> argument to <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> should be a concrete subtype of the <code>AbstractSummaryStat</code> abstract type.</p><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.AbstractSummaryStat" href="#ParticleDA.AbstractSummaryStat"><code>ParticleDA.AbstractSummaryStat</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractSummaryStat</code></pre><p>Abstract type for summary statistics of particle ensemble. Concrete subtypes can be passed as the <code>filter_type</code> argument to <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> to specify which summary statistics to record and how they are computed.</p><p>See also: <a href="#ParticleDA.AbstractSumReductionSummaryStat"><code>AbstractSumReductionSummaryStat</code></a>,  <a href="#ParticleDA.AbstractCustomReductionSummaryStat"><code>AbstractCustomReductionSummaryStat</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/statistics.jl#L1-L10">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.AbstractCustomReductionSummaryStat" href="#ParticleDA.AbstractCustomReductionSummaryStat"><code>ParticleDA.AbstractCustomReductionSummaryStat</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractCustomReductionSummaryStat &lt;: AbstractSummaryStat</code></pre><p>Abstract type for summary statistics computed using custom MPI reductions. Allows greater flexibility in computing statistics which can support more numerically stable implementations, but at a cost of not being compatible with all CPU architectures. In particular, <code>MPI.jl</code> does not currently support custom operators  <a href="https://github.com/JuliaParallel/MPI.jl/issues/404">on Power PC and ARM architecures</a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/statistics.jl#L22-L30">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.AbstractSumReductionSummaryStat" href="#ParticleDA.AbstractSumReductionSummaryStat"><code>ParticleDA.AbstractSumReductionSummaryStat</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">AbstractSumReductionSummaryStat &lt;: AbstractSummaryStat</code></pre><p>Abstract type for summary statistics computed using standard MPI sum reductions.  Compatible with a wider range of CPU architectures but may require less numerically stable implementations.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/statistics.jl#L13-L19">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.MeanAndVarSummaryStat" href="#ParticleDA.MeanAndVarSummaryStat"><code>ParticleDA.MeanAndVarSummaryStat</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">MeanAndVarSummaryStat &lt;: AbstractCustomReductionSummaryStat</code></pre><p>Custom reduction based summary statistic type which computes the means and variances o the particle ensemble for each state dimension. On CPU architectures which do not support custom reductions <a href="#ParticleDA.NaiveMeanAndVarSummaryStat"><code>NaiveMeanAndVarSummaryStat</code></a> can be used instead.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/statistics.jl#L137-L143">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.MeanSummaryStat" href="#ParticleDA.MeanSummaryStat"><code>ParticleDA.MeanSummaryStat</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">MeanSummaryStat &lt;: AbstractCustomReductionSummaryStat</code></pre><p>Custom reduction based summary statistic type which computes the means of the particle ensemble for each state dimension. On CPU architectures which do not support custom reductions <a href="#ParticleDA.NaiveMeanSummaryStat"><code>NaiveMeanSummaryStat</code></a> can be used instead.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/statistics.jl#L113-L119">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.NaiveMeanAndVarSummaryStat" href="#ParticleDA.NaiveMeanAndVarSummaryStat"><code>ParticleDA.NaiveMeanAndVarSummaryStat</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">NaiveMeanAndVarSummaryStat &lt;: AbstractSumReductionSummaryStat</code></pre><p>Sum reduction based summary statistic type which computes the means and variances of the particle ensemble for each state dimension. The mean and variance are computed by directly accumulating the  sums of the particle values, the squared particle values and number of particles on each rank, with the variance computed as the scaled difference between the sum of the squares and square of the sums. This &#39;naive&#39; implementation avoids custom MPI reductions but can be numerically unstable for large ensembles or state components with large values. If custom reductions are supported by the CPU architecture in use the more numerically stable <a href="#ParticleDA.MeanAndVarSummaryStat"><code>MeanAndVarSummaryStat</code></a> should be used instead.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/statistics.jl#L56-L68">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.NaiveMeanSummaryStat" href="#ParticleDA.NaiveMeanSummaryStat"><code>ParticleDA.NaiveMeanSummaryStat</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">NaiveMeanSummaryStat &lt;: AbstractSumReductionSummaryStat</code></pre><p>Sum reduction based summary statistic type which computes the means of the particle ensemble for each state dimension. The mean is computed by directly accumulating the  sums of the particle values and number of particles on each rank. If custom reductions  are supported by the CPU architecture in use the more numerically stable  <a href="#ParticleDA.MeanSummaryStat"><code>MeanSummaryStat</code></a> should be used instead.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/statistics.jl#L33-L41">source</a></section></article><p>The next section details how to write the interface between the model and the particle filter.</p><h3 id="Interfacing-the-model"><a class="docs-heading-anchor" href="#Interfacing-the-model">Interfacing the model</a><a id="Interfacing-the-model-1"></a><a class="docs-heading-anchor-permalink" href="#Interfacing-the-model" title="Permalink"></a></h3><p>The model needs to define a custom data structure and a few functions, that will be used by <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a>:</p><ul><li>a custom structure which holds the data about the model.  This will be used to dispatch the methods to be defined, listed below;</li><li>an initialisation function with the following signature:<pre><code class="language-julia hljs">init(params_dict::Dict) -&gt; model</code></pre>with <code>params_dict</code> a dictionary with the parameters of the model. This initialisation  function should create an instance of the model data structure and return it.</li><li>The model needs to extend the following methods, using the model type for dispatch:</li></ul><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_state_dimension" href="#ParticleDA.get_state_dimension"><code>ParticleDA.get_state_dimension</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_state_dimension(model) -&gt; Integer</code></pre><p>Return the positive integer dimension of the state vector which is assumed to be fixed for all time steps.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L3-L11">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_observation_dimension" href="#ParticleDA.get_observation_dimension"><code>ParticleDA.get_observation_dimension</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_observation_dimension(model) -&gt; Integer</code></pre><p>Return the positive integer dimension of the observation vector which is assumed to be fixed for all time steps.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L14-L22">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_state_eltype" href="#ParticleDA.get_state_eltype"><code>ParticleDA.get_state_eltype</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_state_eltype(model) -&gt; Type</code></pre><p>Return the element type of the state vector which is assumed to be fixed for all time steps.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L25-L33">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_observation_eltype" href="#ParticleDA.get_observation_eltype"><code>ParticleDA.get_observation_eltype</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_observation_eltype(model) -&gt; Type</code></pre><p>Return the element type of the observation vector which is assumed to be fixed for all time steps.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L36-L44">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.sample_initial_state!" href="#ParticleDA.sample_initial_state!"><code>ParticleDA.sample_initial_state!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.sample_initial_state!(state, model, rng)</code></pre><p>Sample value for state vector from its initial distribution for model described by  <code>model</code> using random number generator <code>rng</code> to generate random draws and writing to <code>state</code> argument. </p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L47-L56">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.update_state_deterministic!" href="#ParticleDA.update_state_deterministic!"><code>ParticleDA.update_state_deterministic!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.update_state_deterministic!(state, model, time_index)</code></pre><p>Apply the deterministic component of the state time update at discrete time index  <code>time_index</code> for the model described by <code>model</code> for the state vector <code>state</code> writing the updated state back to the <code>state</code> argument.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L59-L68">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.update_state_stochastic!" href="#ParticleDA.update_state_stochastic!"><code>ParticleDA.update_state_stochastic!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.update_state_stochastic!(state, model, rng)</code></pre><p>Apply the stochastic component of the state time update for the model described by <code>model</code> for the state vector <code>state</code>, using random number generator <code>rng</code> to generate random draws and writing the updated state back to the <code>state</code> argument.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L71-L80">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.sample_observation_given_state!" href="#ParticleDA.sample_observation_given_state!"><code>ParticleDA.sample_observation_given_state!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.sample_observation_given_state!(observation, state, model, rng)</code></pre><p>Simulate noisy observations of the state <code>state</code> of model described by <code>model</code> and write to <code>observation</code> array using <code>rng</code> to generate any random draws.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L83-L91">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_log_density_observation_given_state" href="#ParticleDA.get_log_density_observation_given_state"><code>ParticleDA.get_log_density_observation_given_state</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_log_density_observation_given_state(
    observation, state, model
) -&gt; Real</code></pre><p>Return the logarithm of the probability density of an observation vector <code>observation</code> given a state vector <code>state</code> for the model associated with <code>model</code>. Any additive  terms that are constant with respect to the state may be neglected.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L94-L105">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.write_model_metadata" href="#ParticleDA.write_model_metadata"><code>ParticleDA.write_model_metadata</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.write_model_metadata(file::HDF5.File, model)</code></pre><p>Write metadata for with the model described by <code>model</code> to the HDF5 file <code>file</code>.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L108-L115">source</a></section></article><ul><li>Optionally, if the model has additive Gaussian observation and state noise, it may also extend the following methods, again using the model type for dispatch, to allow using the more statistically efficient <code>OptimalFilter</code> for filtering</li></ul><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_observation_mean_given_state!" href="#ParticleDA.get_observation_mean_given_state!"><code>ParticleDA.get_observation_mean_given_state!</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_observation_mean_given_state!(observation_mean, state, model)</code></pre><p>Compute the mean of the multivariate normal distribution on the observations given the current state and write to the first argument.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>. Only required for filtering conditionally Gaussian models with  the optimal proposal filter implementation in <a href="#ParticleDA.OptimalFilter"><code>OptimalFilter</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L120-L129">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_covariance_state_noise" href="#ParticleDA.get_covariance_state_noise"><code>ParticleDA.get_covariance_state_noise</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_covariance_state_noise(model, i, j) -&gt; Real</code></pre><p>Return covariance <code>cov(U[i], U[j])</code> between components of the zero-mean Gaussian state  noise vector <code>U</code>.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>. Only required for filtering conditionally Gaussian models with  the optimal proposal filter implementation in <a href="#ParticleDA.OptimalFilter"><code>OptimalFilter</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L132-L141">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_covariance_observation_noise" href="#ParticleDA.get_covariance_observation_noise"><code>ParticleDA.get_covariance_observation_noise</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_covariance_observation_noise(model, i, j) -&gt; Real</code></pre><p>Return covariance <code>cov(V[i], V[j])</code> between components of the zero-mean Gaussian  observation noise vector <code>V</code>.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>. Only required for filtering conditionally Gaussian models with  the optimal proposal filter implementation in <a href="#ParticleDA.OptimalFilter"><code>OptimalFilter</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L144-L153">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_covariance_state_observation_given_previous_state" href="#ParticleDA.get_covariance_state_observation_given_previous_state"><code>ParticleDA.get_covariance_state_observation_given_previous_state</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_covariance_state_observation_given_previous_state(
    model, i, j
) -&gt; Real</code></pre><p>Return the covariance <code>cov(X[i], Y[j])</code> between components of the state vector  <code>X = F(x) + U</code> and observation vector <code>Y = H * X + V</code> where <code>H</code> is the linear  observation operator, <code>F</code> the (potentially non-linear) forward operator describing the  deterministic state dynamics, <code>U</code> is a zero-mean Gaussian state noise vector, <code>V</code> is a  zero-mean Gaussian observation noise vector and <code>x</code> is the state at the previous  observation time.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>. Only required for filtering conditionally Gaussian models with  the optimal proposal filter implementation in <a href="#ParticleDA.OptimalFilter"><code>OptimalFilter</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L156-L171">source</a></section></article><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.get_covariance_observation_observation_given_previous_state" href="#ParticleDA.get_covariance_observation_observation_given_previous_state"><code>ParticleDA.get_covariance_observation_observation_given_previous_state</code></a> — <span class="docstring-category">Function</span></header><section><div><pre><code class="language-julia hljs">ParticleDA.get_covariance_observation_observation_given_previous_state(
    model, i, j
) -&gt; Real</code></pre><p>Return covariance <code>cov(Y[i], Y[j])</code> between components of the observation vector  <code>Y = H * (F(x) + U) + V</code> where <code>H</code> is the linear observation operator, <code>F</code> the  (potentially non-linear) forward operator describing the deterministic state dynamics, <code>U</code> is a zero-mean Gaussian state noise vector, <code>V</code> is a zero-mean Gaussian observation noise vector and <code>x</code> is the state at the previous observation time.</p><p>This method is intended to be extended by the user with the above signature, specifying the type of <code>model</code>. Only required for filtering conditionally Gaussian models with  the optimal proposal filter implementation in <a href="#ParticleDA.OptimalFilter"><code>OptimalFilter</code></a>.</p></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/models.jl#L174-L188">source</a></section></article><h3 id="Input-parameters"><a class="docs-heading-anchor" href="#Input-parameters">Input parameters</a><a id="Input-parameters-1"></a><a class="docs-heading-anchor-permalink" href="#Input-parameters" title="Permalink"></a></h3><p>You can store the input parameters in an YAML file with the following structure</p><pre><code class="language-yaml hljs">filter:
  key1: value1

model:
  model_name1:
    key2: value2
    key3: value3
  model_name2:
    key4: value4
    key5: value5</code></pre><p>The parameters under <code>filter</code> are related to the particle filter, under <code>model</code> you can specify the parameters for different models.</p><p>The particle filter parameters are saved in the following data structure:</p><article class="docstring"><header><a class="docstring-binding" id="ParticleDA.FilterParameters" href="#ParticleDA.FilterParameters"><code>ParticleDA.FilterParameters</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">FilterParameters()</code></pre><p>Parameters for ParticleDA run. Keyword arguments:</p><ul><li><code>master_rank</code> : Id of MPI rank that performs serial computations</li><li><code>verbose::Bool</code> : Flag to control whether to write output</li><li><code>output_filename::String</code> : Name of output file</li><li><code>nprt::Int</code> : Number of particles for particle filter</li><li><code>enable_timers::Bool</code> : Flag to control run time measurements</li><li><code>particle_save_time_indices</code>: Set of time indices to save particles at</li><li><code>seed</code>: Seed to initialise state of random number generator used for filtering</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/src/params.jl#L1-L13">source</a></section></article><h2 id="Example:-estimating-the-state-in-a-tsunami-model"><a class="docs-heading-anchor" href="#Example:-estimating-the-state-in-a-tsunami-model">Example: estimating the state in a tsunami model</a><a id="Example:-estimating-the-state-in-a-tsunami-model-1"></a><a class="docs-heading-anchor-permalink" href="#Example:-estimating-the-state-in-a-tsunami-model" title="Permalink"></a></h2><p>A full example of a model interfacing <code>ParticleDA</code> is available in <code>test/models/llw2d.jl</code>.  This model represents a simple two dimensional simulation of tsunami dynamics and is  partly based on the <a href="https://github.com/tktmyd/tdac">tsunami data assimilation code</a> by  Takuto Maeda. The particle filter can be run with observations simulated from the model as follows</p><pre><code class="language-julia hljs"># Load ParticleDA
using ParticleDA

# Save some variables for later use
test_dir = joinpath(dirname(pathof(ParticleDA)), &quot;..&quot;, &quot;test&quot;)
llw2d_src = joinpath(test_dir, &quot;models&quot;, &quot;llw2d.jl&quot;)
input_file = joinpath(test_dir, &quot;integration_test_1.yaml&quot;)
observation_file = tempname()

# Instantiate the test environment
using Pkg
Pkg.activate(test_dir)
Pkg.instantiate()

# Include the sample model source code and load it
include(llw2d_src)
using .LLW2d

# Simulate observations from the model to use 
simulate_observations_from_model(LLW2d.init, input_file, observation_file)

# Run the (optimal proposal) particle filter with simulated observations computing the
# mean and variance of the particle ensemble. On non-Intel architectures you may need
# to use NaiveMeanAndVarSummaryStat instead
final_states, final_statistics = run_particle_filter(
  LLW2d.init, input_file, observation_file, OptimalFilter, MeanAndVarSummaryStat
)</code></pre><h3 id="Parameters-of-the-test-model"><a class="docs-heading-anchor" href="#Parameters-of-the-test-model">Parameters of the test model</a><a id="Parameters-of-the-test-model-1"></a><a class="docs-heading-anchor-permalink" href="#Parameters-of-the-test-model" title="Permalink"></a></h3><p>The <a href="#Input-parameters">Input parameters</a> section shows how to pass the input parameters for the filter and the model.  For the model included in the test suite, called <code>llw2d</code>, you can set the following parameters:</p><article class="docstring"><header><a class="docstring-binding" id="Main.LLW2d.LLW2dModelParameters" href="#Main.LLW2d.LLW2dModelParameters"><code>Main.LLW2d.LLW2dModelParameters</code></a> — <span class="docstring-category">Type</span></header><section><div><pre><code class="language-julia hljs">LLW2dModelParameters()</code></pre><p>Parameters for the linear long wave two-dimensional (LLW2d) model. Keyword arguments:</p><ul><li><code>nx::Int</code> : Number of grid points in the x direction</li><li><code>ny::Int</code> : Number of grid points in the y direction</li><li><code>x_length::AbstractFloat</code> : Domain size in metres in the x direction</li><li><code>y_length::AbstractFloat</code> : Domain size in metres in the y direction</li><li><code>dx::AbstractFloat</code> : Distance in metres between grid points in the x direction</li><li><code>dy::AbstractFloat</code> : Distance in metrtes between grid points in the y direction</li><li><code>station_filename::String</code> : Name of input file for station coordinates</li><li><code>n_stations_x::Int</code> : Number of observation stations in the x direction (if using regular grid)</li><li><code>n_stations_y::Int</code> : Number of observation stations in the y direction (if using regular grid)</li><li><code>station_distance_x::Float</code> : Distance in metres between stations in the x direction (if using regular grid)</li><li><code>station_distance_y::Float</code> : Distance in metres between stations in the y direction (if using regular grid)</li><li><code>station_boundary_x::Float</code> : Distance in metres between bottom left edge of box and first station in the x direction (if using regular grid)</li><li><code>station_boundary_y::Float</code> : Distance in metres between bottom left edge of box and first station in the y direction (if using regular grid)</li><li><code>n_integration_step::Int</code> : Number of sub-steps to integrate the forward model per time step</li><li><code>time_step::AbstractFloat</code> : Time step length in seconds</li><li><code>peak_position::Vector{AbstractFloat}</code> : The `[x, y] coordinates in metres of the initial wave peak</li><li><code>peak_height::AbstractFloat</code> : The height in metres of the initial wave peak</li><li><code>source_size::AbstractFloat</code> : Cutoff distance in metres from the peak for the initial wave</li><li><code>bathymetry_setup::AbstractFloat</code> : Bathymetry set-up</li><li><code>lambda::AbstractFloat</code> : Length scale for Matérn covariance kernel in background noise</li><li><code>nu::AbstractFloat</code> : Smoothess parameter for Matérn covariance kernel in background noise</li><li><code>sigma::AbstractFloat</code> : Marginal standard deviation for Matérn covariance kernel in background noise</li><li><code>lambda_initial_state::AbstractFloat</code> : Length scale for Matérn covariance kernel in initial state of particles</li><li><code>nu_initial_state::AbstractFloat</code> : Smoothess parameter for Matérn covariance kernel in initial state of particles</li><li><code>sigma_initial_state::AbstractFloat</code> : Marginal standard deviation for Matérn covariance kernel in initial state of particles</li><li><code>padding::Int</code> : Min padding for circulant embedding gaussian random field generator</li><li><code>primes::Int</code>: Whether the size of the minimum circulant embedding of the covariance matrix can be written as a product of small primes (2, 3, 5 and 7). Default is <code>true</code>.</li><li><code>use_peak_initial_state_mean::Bool</code>: Whether to set mean of initial height field to a wave peak (true) or to all zeros (false).  In both cases the initial mean of the other state variables is zero.</li><li><code>absorber_thickness_fraction::Float</code> : Thickness of absorber for sponge absorbing boundary conditions, fraction of grid size</li><li><code>boundary_damping::Float</code> : Damping for boundaries</li><li><code>cutoff_depth::Float</code> : Shallowest water depth</li><li><code>obs_noise_std::Vector</code>: Standard deviations of noise added to observations of the true state</li><li><code>observed_state_var_indices::Vector</code>: Vector containing the indices of the observed state variables (1: height, 2: velocity x-component, 3: velocity y-component)</li></ul></div><a class="docs-sourcelink" target="_blank" href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/fd077fcbe9a6b3903898f123aae3446953b2307a/test/models/llw2d.jl#L11-L50">source</a></section></article><h3 id="Observation-station-coordinates"><a class="docs-heading-anchor" href="#Observation-station-coordinates">Observation station coordinates</a><a id="Observation-station-coordinates-1"></a><a class="docs-heading-anchor-permalink" href="#Observation-station-coordinates" title="Permalink"></a></h3><p>The coordinates of the observation stations can be set in two different ways.</p><ol><li><p>Provide the coordinates in an input file. Set the parameter <code>station_filename</code> to the name of your input file. The input file is in plain text, the format is one row per station containing x, y - coordinates in metres. Here is a simple example with two stations</p><pre><code class="language-julia hljs"># Comment lines starting with &#39;#&#39; will be ignored by the code
# This file contains two stations: at [1km, 1km] and [2km, 2km]
1.0e3, 1.0e3
2.0e3, 2.0e3</code></pre></li><li><p>Provide parameters for an equispaced rectilinear grid of observation stations. The values of these parameters should then be set:</p><ul><li><code>n_stations_x</code> : Number of observation stations in the x direction</li><li><code>n_stations_y</code> : Number of observation stations in the y direction</li><li><code>station_distance_x</code> : Distance between stations in the x direction (m)</li><li><code>station_distance_y</code> : Distance between stations in the y direction (m)</li><li><code>station_boundary_x</code> : Distance between bottom left edge of box and first station in the x direction (m)</li><li><code>station_boundary_y</code> : Distance between bottom left edge of box and first station in the y direction (m)</li></ul><p>As an example, one could set</p><pre><code class="language-julia hljs">n_stations_x=2,
n_stations_y=2,
station_distance_x=1.0e3,
station_distance_y=1.0e3,
station_boundary_x=10.0e3,
station_boundary_y=10.0e3,</code></pre><p>to generate 4 stations at <code>[10km, 10km]</code>, <code>[10km, 11km]</code>, <code>[11km, 10km]</code> and <code>[11km, 11km]</code>.</p></li></ol><h2 id="Output"><a class="docs-heading-anchor" href="#Output">Output</a><a id="Output-1"></a><a class="docs-heading-anchor-permalink" href="#Output" title="Permalink"></a></h2><p>If the filter parameter <code>verbose</code> is set to <code>true</code>, <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> will produce an HDF5 file in the run directory. The file name is <code>particle_da.h5</code> by default (this is configurable using the <code>output_filename</code> filter parameter). The file contains the summary statistics of the estimate state distribution (by default the mean and variance), particle weights, parameters used, and other metadata at each time step observation were assimilated. To read the output file, use the <a href="https://www.hdfgroup.org/solutions/hdf5/">HDF5 library</a>.</p><p>A basic plotting tool is provided in a <a href="https://github.com/Team-RADDISH/ParticleDA.jl/blob/master/extra/Plot_tdac_output.ipynb">Jupyter notebook</a>. This is intended as a template to build more sophisticated postprocessing tools, but can be used for some simple analysis. Set the variable <code>timestamp</code> in the third cell to plot different time slices from the output file. More functionality may be added as the package develops.</p><h2 id="Running-in-parallel"><a class="docs-heading-anchor" href="#Running-in-parallel">Running in parallel</a><a id="Running-in-parallel-1"></a><a class="docs-heading-anchor-permalink" href="#Running-in-parallel" title="Permalink"></a></h2><p>The particle state update is parallelised using both MPI and threading. According to our preliminary tests both methods work well at small scale. To use the threading, set the environment variable <code>JULIA_NUM_THREADS</code> to the number of threads you want to use before starting Julia and then call the <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> function normally. You can check the number of threads julia has available by calling in Julia&#39;s REPL</p><pre><code class="language-julia hljs">Threads.nthreads()</code></pre><p>To use the MPI parallelisation, write a Julia script that calls the <a href="#ParticleDA.run_particle_filter"><code>run_particle_filter</code></a> function for the relevant model and observations and run it in an Unix shell with</p><pre><code class="language-bash hljs">mpirun -np &lt;your_number_of_processes&gt; julia &lt;your_julia_script&gt;</code></pre><p>Note that the parallel performance may vary depending on the performance of the algorithm. In general, a degeneracy of the particle weights will lead to poor load balance and parallel performance. See <a href="https://github.com/Team-RADDISH/ParticleDA.jl/issues/115#issuecomment-675468511">this issue</a> for more details.</p><h2 id="Testing"><a class="docs-heading-anchor" href="#Testing">Testing</a><a id="Testing-1"></a><a class="docs-heading-anchor-permalink" href="#Testing" title="Permalink"></a></h2><p>We have a basic test suite for <code>ParticleDA.jl</code>.  You can run the tests by entering the package manager mode in Julia&#39;s REPL with <code>]</code> and running the command</p><pre><code class="nohighlight hljs">test ParticleDA</code></pre><h2 id="License"><a class="docs-heading-anchor" href="#License">License</a><a id="License-1"></a><a class="docs-heading-anchor-permalink" href="#License" title="Permalink"></a></h2><p>The <code>ParticleDA.jl</code> package is licensed under the MIT &quot;Expat&quot; License.</p></article><nav class="docs-footer"><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.23 on <span class="colophon-date" title="Thursday 22 December 2022 18:33">Thursday 22 December 2022</span>. Using Julia version 1.8.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
